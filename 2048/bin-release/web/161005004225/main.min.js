var EventManage=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.addEvent=function(){if(egret.MainContext.deviceType!=egret.MainContext.DEVICE_MOBILE){var e=this;document.addEventListener("keydown",function(t){switch(t.keyCode){case 38:e.doMove(0);break;case 39:e.doMove(1);break;case 40:e.doMove(2);break;case 37:e.doMove(3)}})}egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.mouseDownHandle,this)},n.mouseDownHandle=function(e){console.log("touchdown"),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.stage_mouseMoveHandler,this),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.stage_mouseUpHandler,this),egret.MainContext.instance.stage.addEventListener(egret.Event.LEAVE_STAGE,this.stage_mouseUpHandler,this),this.downPoint=new egret.Point(e.stageX,e.stageY)},n.stage_mouseMoveHandler=function(e){this.movePoint||(this.movePoint=new egret.Point),this.movePoint.x=e.stageX,this.movePoint.y=e.stageY,this.needMove||(this.needMove=!0)},n.stage_mouseUpHandler=function(e){egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.stage_mouseMoveHandler,this),egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.stage_mouseUpHandler,this),egret.MainContext.instance.stage.addEventListener(egret.Event.LEAVE_STAGE,this.stage_mouseUpHandler,this),this.needMove&&(this.updateWhenMouseUp(),this.needMove=!1)},n.updateWhenMouseUp=function(){var e=this.movePoint,t=e.x-this.downPoint.x,i=e.y-this.downPoint.y;0>i&&Math.abs(i)>Math.abs(t)?this.doMove(0):t>0&&t>Math.abs(i)?this.doMove(1):i>0&&i>Math.abs(t)?this.doMove(2):0>t&&Math.abs(t)>Math.abs(i)&&this.doMove(3)},n.doMove=function(e){if(GameManager.getInstance().isRunning){switch(GameManager.getInstance().isRunning=!1,e){case 0:GameManager.getInstance().shang();break;case 1:GameManager.getInstance().you();break;case 2:GameManager.getInstance().xia();break;case 3:GameManager.getInstance().zuo()}var t=new egret.Event("keyDowns");this.dispatchEvent(t)}},t}(egret.EventDispatcher);egret.registerClass(EventManage,"EventManage");var GameEvent=function(e){function t(t,i,n){e.call(this,t,i,n)}__extends(t,e);var i=(__define,t);i.prototype;return t}(egret.Event);egret.registerClass(GameEvent,"GameEvent");var GameManager=function(){function e(){this._rects=[],this._data=[],this._nousedata=[],this.isRunning=!0,this.score=0,this.isHaveMoveRect=!1}var t=(__define,e),i=t.prototype;return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},i.createAllRect=function(){for(var e=0;16>e;e++){var t=new Grid;this._rects[e]=t,this._data[e]=0,this._nousedata[e]=e}},i.selectGrid=function(){for(var e=0;16>e;e++)if(0==this._rects[e].isUsed)return this._rects[e];return null},i.restart=function(){this.score=0,this.isRunning=!0;for(var e=0;16>e;e++)this._data[e]=0,this._rects[e].restart();this.restartAllRect()},i.addGridToDatas=function(e){var t=GameUtil.getIndexByLineRow(e.row,e.column);this._data[t]=e,this.restartAllRect()},i.selectNewPos=function(){var e=this._nousedata[Math.floor(this._nousedata.length*Math.random())];return GameUtil.getPosByIndex(e)},i.restartAllRect=function(){this._nousedata=[];for(var e=1;16>e;e++)0==this._data[e]&&this._nousedata.push(e)},i.shang=function(){for(var e=this.selectArr(0),t=0;4>t;t++)this.moveArr(e[t]),this.unite(e[t]),this.moveArr(e[t]);this.restartAllRect(),this.playAllRect()},i.xia=function(){for(var e=this.selectArr(0),t=0;4>t;t++)e[t]=e[t].reverse(),this.moveArr(e[t]),this.unite(e[t]),this.moveArr(e[t]);this.restartAllRect(),this.playAllRect()},i.zuo=function(){for(var e=this.selectArr(1),t=0;4>t;t++)this.moveArr(e[t]),this.unite(e[t]),this.moveArr(e[t]);this.restartAllRect(),this.playAllRect()},i.you=function(){for(var e=this.selectArr(1),t=0;4>t;t++)e[t]=e[t].reverse(),this.moveArr(e[t]),this.unite(e[t]),this.moveArr(e[t]);this.restartAllRect(),this.playAllRect()},i.isGameOver=function(){for(var e=!0,t=this.selectArr(0),i=0;i<t.length;i++)for(var n=0;3>n;n++)this._data[t[i][n]].num==this._data[t[i][n+1]].num&&(e=!1);t=this.selectArr(1);for(var i=0;i<t.length;i++)for(var n=0;3>n;n++)this._data[t[i][n]].num==this._data[t[i][n+1]].num&&(e=!1);return e},i.moveArr=function(e){for(var t=[],i=0;i<e.length;i++)0!=this._data[e[i]]&&t.push(this._data[e[i]]);for(var n=0;4>n;n++)if(t[n]){this._data[e[n]]=t[n];var s=GameUtil.getPosByIndex(e[n]);this._data[e[n]].row=s.x,this._data[e[n]].column=s.y}else this._data[e[n]]=0},i.selectArr=function(e){for(var t=[],i=0;4>i;i++){for(var n=[],s=0;4>s;s++)0==e?n.push(GameUtil.getIndexByLineRow(s,i)):n.push(GameUtil.getIndexByLineRow(i,s));t.push(n)}return t},i.unite=function(e){for(var t=e.length-1,i=0;t>i;i++)this._data[e[i]].num==this._data[e[i+1]].num&&this._data[e[i+1]]&&(this._data[e[i]].num*=2,this._data[e[i]].nextIsAnm=!0,this._data[e[i+1]].nextIsRemove=!0,this._data[e[i+1]]=0,this.score+=this._data[e[i]].num,i++)},i.playAllRect=function(){for(var e=!1,t=0;16>t;t++)e=this._rects[t].playAnimation(),1==e&&(this.isHaveMoveRect=!0)},e}();egret.registerClass(GameManager,"GameManager");var GameUtil=function(){function e(){}var t=(__define,e);t.prototype;return e.getIndexByLineRow=function(e,t){return 4*e+t},e.getPosByRect=function(e){var t=new egret.Point;return t.x=10+e.width/2+(10+e.width)*e.column,t.y=10+e.width/2+(10+e.width)*e.row,t},e.getPosByIndex=function(e){var t=new egret.Point;return t.x=Math.floor(e/4),t.y=Math.floor(e%4),t},e}();egret.registerClass(GameUtil,"GameUtil");var GameView=function(e){function t(){e.call(this),this._bgView=new egret.Sprite,this.playView=new egret.Sprite,this._overView=new egret.Sprite,this.addChild(this._bgView),this.addChild(this.playView),this.addChild(this._overView),this._overView.visible=!1,this.playView.y=105}__extends(t,e);var i=(__define,t),n=i.prototype;return n.createStaticView=function(){this.createTitleBitmap(),this.createRectBackground(),this.createGameOverLayout(),this.createScoreText()},n.createTitleBitmap=function(){var e=new egret.Bitmap(RES.getRes("menu"));e.width=egret.MainContext.instance.stage.stageWidth,this._bgView.addChild(e)},n.createRectBackground=function(){var e=new egret.Rectangle(16,13,69,70),t=new egret.Bitmap(RES.getRes("background"));t.width=egret.MainContext.instance.stage.stageWidth,t.height=egret.MainContext.instance.stage.stageWidth,t.scale9Grid=e,t.y=105,this._bgView.addChild(t);for(var i=0;4>i;i++)for(var n=0;4>n;n++){var s=new egret.Bitmap(RES.getRes("backtile"));s.x=10+(10+s.width)*n,s.y=115+(10+s.height)*i,this._bgView.addChild(s)}},n.createGameOverLayout=function(){var e=new egret.Bitmap(RES.getRes("frontground"));e.width=egret.MainContext.instance.stage.stageWidth,e.height=egret.MainContext.instance.stage.stageHeight,this._overView.addChild(e);var t=new egret.Sprite,i=new egret.Bitmap(RES.getRes("continueButton_over"));t.addChild(i),t.x=(e.width-i.width)/2,t.y=(e.height-i.height)/2,t.width=i.width,t.width=i.height,t.touchEnabled=!0,this._overView.addChild(t),t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onRestart,this)},n.showGameOverLayout=function(){this._overView.visible=!0},n.onRestart=function(){GameManager.getInstance().restart(),this._overView.visible=!1;var e=new egret.Event("gameRestart");this.dispatchEvent(e)},n.createScoreText=function(){this.txt=new egret.TextField,this.txt.x=400,this.txt.y=30,this._bgView.addChild(this.txt),this.updateScore()},n.updateScore=function(){this.txt.text=String(GameManager.getInstance().score)},t}(egret.Sprite);egret.registerClass(GameView,"GameView");var Grid=function(e){function t(){e.call(this),this.isUsed=!1,this._num=2,this.row=0,this.column=0,this.nextIsRemove=!1,this.nextIsAnm=!1,this.anchorOffsetX=50,this.anchorOffsetY=50,this.addEventListener(egret.Event.ADDED,this.onAddChild,this)}__extends(t,e);var i=__define,n=t,s=n.prototype;return s.restart=function(){this.parent&&this.parent.removeChild(this),this.isUsed=!1,this.row=0,this.column=0,this.nextIsAnm=!1,this.nextIsRemove=!1},s.onAddChild=function(){this.scaleX=0,this.scaleY=0,egret.Tween.get(this).to({scaleX:1,scaleY:1},100)},i(s,"num",function(){return this._num},function(e){this._num=e,this.texture=RES.getRes("number"+this._num)}),s.playAnimation=function(){var e=!1;if(this.isUsed){var t=egret.Tween.get(this),i=GameUtil.getPosByRect(this);(this.x!=i.x||this.y!=i.y)&&(e=!0),t.to({x:i.x,y:i.y},100),t.call(this.animationOver,this)}return e},s.animationOver=function(){if(this.nextIsAnm){var e=egret.Tween.get(this);e.to({scaleX:1.1,scaleY:1.1},100),e.call(this.backScale)}this.nextIsRemove&&(this.parent.removeChild(this),this.num=2,this.row=0,this.column=0,this.isUsed=!1,this.texture=null),this.nextIsAnm=!1,this.nextIsRemove=!1},s.backScale=function(){egret.Tween.get(this).to({scaleX:1,scaleY:1},100)},t}(egret.Bitmap);egret.registerClass(Grid,"Grid");var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var i=(__define,t),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},n.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t),n=i.prototype;return n.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onGroupComp,this),RES.loadGroup("preload")},n.onGroupComp=function(){this.res=RES.getRes("res_json"),this.gameView=new GameView,this.gameView.createStaticView(),this.gameView.addEventListener("gameRestart",this.onRestart,this),this.addChild(this.gameView),this._time=new egret.Timer(110,1),this._time.addEventListener(egret.TimerEvent.TIMER,this.onTimerComplete,this),GameManager.getInstance().createAllRect(),this.createNewRect(),this.createNewRect(),this.eventManage=new EventManage,this.eventManage.addEvent(),this.eventManage.addEventListener("keyDowns",this.keyDowns,this)},n.createNewRect=function(){var e=GameManager.getInstance().selectNewPos(),t=GameManager.getInstance().selectGrid();t.isUsed=!0,t.num=2,t.row=e.x,t.column=e.y;var i=GameUtil.getPosByRect(t);t.x=i.x,t.y=i.y,GameManager.getInstance().addGridToDatas(t),this.gameView.playView.addChild(t)},n.keyDowns=function(){this.gameView.updateScore(),GameManager.getInstance().isGameOver()?(console.log("游戏结束"),this.gameView.showGameOverLayout()):this._time.start()},n.onTimerComplete=function(){GameManager.getInstance().isRunning=!0,0!=GameManager.getInstance()._nousedata.length&&1==GameManager.getInstance().isHaveMoveRect&&(GameManager.getInstance().isHaveMoveRect=!1,this.createNewRect())},n.onRestart=function(){this.gameView.updateScore(),this.createNewRect(),this.createNewRect()},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");